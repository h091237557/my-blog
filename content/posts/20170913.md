---
title: "Socket.io çš„æ¶æ§‹"
date: 2017-09-13T19:51:35+08:00
draft: false
tags: 
- instant messaging  
- socket.io
keywords:
- socket 
- socket.io
---

socket.io æ˜¯ node js çš„ä¸€å€‹ frameworkï¼Œå®ƒå¯ä»¥å¹«åŠ©æˆ‘å€‘å»ºç«‹èŠå¤©å®¤é€™ç¨®æ¨æ’­åŠŸèƒ½çš„ç³»çµ±ï¼Œé€™ç¯‡æ–‡ç« æˆ‘å€‘ä¸æœƒèªªæ˜å®ƒå¦‚ä½•ä½¿ç”¨ï¼Œè€Œæ˜¯è¦ç†è§£ socket.io é€™å€‹å¥—ä»¶çš„æ¶æ§‹çµ„æˆã€‚

socket.io ä¸»è¦ç”±ä»¥ä¸‹å¹¾å€‹æ±æ±æ§‹æˆçš„ : 

* engine.ioã€engino.io-client
* socket.io-parser
* socket.io-adapter
* socket.io-client
* socket.io-protocol

æ¥ä¸‹ä¾†æˆ‘å€‘å°‡ä¸€å€‹ä¸€å€‹èªªæ˜å®ƒå€‘æ˜¯åšå•¥ç”¨çš„ï¼Œä¸¦ä¸”æœ€å¾Œæœƒåœ¨é€²è¡Œä¸€å€‹ç¸½çµã€‚

## engine.io
`engine.io`æ˜¯ä¸€å€‹å¯¦éš›åŸ·è¡Œ socket.io é€šè¨Šå±¤ç´šçš„ libaryï¼Œåš´æ ¼èªªèµ·ä¾†ï¼Œ`socket.io çš„æ ¸å¿ƒå°±æ˜¯engine.io`ï¼Œæ‰€æœ‰çš„å»ºç«‹é€£ç·šã€å‚³è¼¸è³‡è¨Šå¯¦éš›ä¸Šéƒ½æ˜¯ç”±å®ƒä¾†åšï¼Œä¸¦ä¸”æ ¹æ“šå‰ç«¯å‚³é€å›ä¾†çš„è³‡è¨Šï¼Œä¾†æ±ºå®šä½¿ç”¨ä»€éº¼å‚³è¼¸æ–¹å¼ã€‚

ç›®å‰ engine.io æ‰€æä¾›çš„æºé€šæ–¹å¼æœ‰ä»¥ä¸‹å¹¾ç¨® : 

* polling-jsonp
* polling-xhr
* pollin
* websocket

ä¸Šé¢æœ‰æåˆ°ï¼Œsocket.io æœ¬èº«ä¸æä¾›é€£ç·šåŠŸèƒ½ï¼Œè€Œæ˜¯åœ¨ engine.io æ‰æä¾›ï¼Œæ‰€ä»¥äº‹å¯¦ä¸Šï¼Œå¦‚æœä½ æ²’æœ‰ä¸€å®šè¦ä½¿ç”¨åˆ° socket.io çš„åŠŸèƒ½ï¼Œè€Œåªæ˜¯è¦é€£ç·šåˆ° http server æˆ–æ˜¯ç›£è½ port çš„è©±ï¼Œåªè¦ç”¨ engine.io å°±å¤ äº†ï¼Œé€™é‚Šæœ‰å€‹é‡é»è¦è¨˜å¾— socket.io æ˜¯å€‹ framework è€Œ engine.io åªæ˜¯å€‹ libaryï¼Œåªè¦åˆ†çš„å‡ºé€™å…©å€‹å·®åˆ¥ï¼Œä½ å°±å¯ä»¥è‡ªç”±çš„é¸ä½ è¦çš„ä½¿ç”¨ã€‚

```js
var engine = require('engine.io');
var server = engine.listen(80);

server.on('connection', function(socket){
  socket.send('utf 8 string');
  socket.send(new Buffer([0, 1, 2, 3, 4, 5])); // binary data
});
```

## engino.io-client

`engine.io-client`æ˜¯`socket.io-client`çš„æ ¸å¿ƒï¼Œæ‰€æœ‰é—œéµçš„é€£ç·šã€é¸æ“‡å‚³è¼¸æ–¹å¼ï¼Œéƒ½æ˜¯åœ¨é€™è£¡é¢åŸ·è¡Œã€‚

æˆ‘å€‘é€™è£¡ä¾†çœ‹çœ‹ï¼Œå®ƒæ˜¯å¾é‚£æ±ºå®šè¦ç”¨é‚£ç¨®çš„`å‚³è¼¸æ–¹å¼`(websocketã€polling)ã€‚

åœ¨`engine.io-client`ä¸‹é¢é€™æ®µç¨‹å¼ç¢¼([ç¨‹å¼ç¢¼å‚³é€é–€](https://github.com/socketio/engine.io-client/blob/master/lib/socket.js#L405))ä¸­ ï¼Œé€™æ®µ`onOpen`æ˜¯åœ¨ socket è¦èˆ‡ server é€²è¡Œé€£ç·šæ™‚ï¼Œæœƒå…ˆåŸ·è¡Œçš„äº‹ä»¶ï¼Œå…¶ä¸­ï¼Œå°±æ˜¯ç”±`this.probe(this.upgrades[i])`é€™å€‹æ–¹æ³•ä¾†æ±ºå®šè¦ç”¨ä»€éº¼æ–¹å¼(websocketã€polling)ä¾†é€²è¡Œå‚³è¼¸ã€‚

```js
Socket.prototype.onOpen = function () {
  debug('socket open');
  this.readyState = 'open';
  Socket.priorWebsocketSuccess = 'websocket' === this.transport.name;
  this.emit('open');
  this.flush();

  // we check for `readyState` in case an `open`
  // listener already closed the socket
  if ('open' === this.readyState && this.upgrade && this.transport.pause) {
    debug('starting upgrade probes');
    for (var i = 0, l = this.upgrades.length; i < l; i++) {
      this.probe(this.upgrades[i]);
    }
  }
};
```

ç„¶å¾Œåœ¨å¾Œç«¯ server ï¼Œä¹Ÿå°±æ˜¯`engine.io`è£¡æ ¹æ“šå‰ç«¯å‚³é€å›ä¾†çš„`url`åƒæ•¸çš„`Transport`ä¾†æ±ºå®šè¦ç”¨ä»€éº¼ä¾†é€²è¡Œå‚³è¼¸ : 

```
url ç¯„ä¾‹ : 

/engine.io/default/?transport=polling
```

`engine.io`çš„ä¸‹é¢é€™æ®µç¨‹å¼ç¢¼è£¡ï¼Œ`check`ç”¨ä¾†é©—è­‰å‚³é€²ä¾†çš„åƒæ•¸æ˜¯å¦åˆæ³•ï¼Œä¾†æ±ºå®šé€™å€‹`transport`åƒæ•¸æ˜¯å¦åˆæ³•ï¼Œç„¶å¾Œå†ä¾†å°‡ http å‡ç´šç‚º websocket å”ç¾©ã€‚


```js
server.on('upgrade', function (req, socket, head) {
      if (check(req)) {
        self.handleUpgrade(req, socket, head);
      } else if (false !== options.destroyUpgrade) {
        // default node behavior is to disconnect when no handlers
        // but by adding a handler, we prevent that
        // and if no eio thing handles the upgrade
        // then the socket needs to die!
        setTimeout(function () {
          if (socket.writable && socket.bytesWritten <= 0) {
            return socket.end();
          }
        }, destroyUpgradeTimeout);
      }
    });
```
## socket.io-parser

åœ¨ socket.io çš„ä¸–ç•Œä¸­ï¼Œæœ‰ä¸€å€‹æ±è¥¿å«åš `packet`ï¼Œå®ƒæ˜¯æ‰€æœ‰æºé€šçš„åŸºç¤åŒ…ï¼Œäº‹å¯¦ä¸Šå®ƒä¹Ÿå°±æ˜¯ socket.io çš„å”è­°ï¼Œæœ‰ä¸€å€‹æ±è¥¿å«`socket.io-protocol`([å‚³é€é–€](https://github.com/socketio/socket.io-protocol))ï¼Œå®ƒè£¡é¢æœ‰å®šè­°å¥½ï¼Œä½ é€™å€‹ packet è¦é•·ä»€éº¼æ¨£å­ã€‚

ä¸‹é¢ç‚ºæœ€ç°¡å–®çš„ packet åŒ… : 

```
{
    type: 2,
    data: [{
        word: "hello mark"
    },{
        word: "hello gg"
    }]
}
```
å…¶ä¸­`2`æ‰€ä»£è¡¨çš„ç‚ºé€™å€‹ packet æ˜¯è¦ç”¨ä¾†è™•ç†`event`äº‹ä»¶ï¼Œåƒè¦å‚³é€åˆ°å‰ç«¯çš„äº‹ä»¶ä¹Ÿæ˜¯ç”¨é€™å€‹ä»£è™Ÿï¼Œé€™å€‹æ•¸å­—æœƒç”± socket.io-protocol è£¡å®šç¾©å¥½ã€‚

ç„¶å¾Œæ¯ç•¶æˆ‘å€‘è¦å‚³é€ packet åˆ°å‰ç«¯æ™‚ï¼Œéƒ½æœƒå…ˆä½¿ç”¨socket.io-parser`å°‡ packet çµ¦ encode ï¼Œè€Œè‡´æ–¼ç‚ºä»€éº¼è¦ encode å¾Œåœ¨å‚³å‘¢ ? ä¸»è¦åŸå› ï¼Œå¯èƒ½æ˜¯å¸Œæœ›å„˜å¯èƒ½çš„å°‡è¦å‚³é€å‡ºå»çš„ packet ç¸®å°å·²ç¯€çœå‚³è¼¸æˆæœ¬ã€‚

åƒå®˜æ–¹æ‰€æä¾›çš„`socket.io-parser`æœƒå°‡ä¸Šé¢çš„ packet åŒ… encode æˆå¦‚ä¸‹æ•¸æ“š : 

```
"2[{"word":"hello mark"},{"word":"hello gg"}]"
```
å®ƒçš„ç¢ºæ¯”åŸæœ¬è¦å‚³è¼¸çš„è³‡æ–™é‚„å°‘é»å…’æ±è¥¿ï¼Œç„¶å¾Œå‰ç«¯åœ¨å†ç”¨ç›¸åŒçš„`socket.io-parser`ä¾†é€²è¡Œ`decode`ï¼Œè®ŠæˆåŸä¾†çš„ packet åŒ…ã€‚

é€™å°±æ˜¯`socket.io-parser`æ‰€åšçš„äº‹æƒ…ï¼Œç•¶ç„¶æˆ‘å€‘ä¹Ÿå¯ä»¥è‡ªè¨‚ä¸€å€‹ parser ï¼Œå¦‚æœä½ æœ‰éœ€è¦çš„è©±ï¼Œä¾‹å¦‚ä½ æƒ³ä½¿ç”¨ xml ä¾†ç•¶å‚³è¼¸æ ¼å¼ï¼Œé€™æ™‚ä½ å°±è¦è‡ªè¨‚ä¸€å€‹ parser äº†ï¼Œé›–ç„¶è¦ºå¾—æ‡‰è©²ä¸æœƒæƒ³ç”¨xmlä¾†å‚³ã€‚

## socket.io-adapter

åœ¨ç†è§£é€™å¥—ä»¶ä¹‹å‰ï¼Œæˆ‘å€‘å…ˆçœ‹çœ‹`adapter`é€™ä»£è¡¨ä»€éº¼æ„æ€å‘¢ ? æˆ‘å€‘ç›´æ¥ç”¨é€™å€‹å–®å­—å» google åœ–ç‰‡ä¸€ä¸‹ï¼Œç„¶å¾Œå¯ä»¥çœ‹åˆ°ä¸‹åœ–çš„çµæœ : 

![](http://yixiang8780.com/outImg/20171011-2.jpg)

å—¯å“¼ï¼Œå°±æ˜¯é›»æºè½‰æ¥å™¨ï¼Œåœ¨æ’é ­å’Œæˆ‘å€‘çš„æ©Ÿå™¨ä¹‹é–“æ‰€éœ€è¦çš„æ±è¥¿ï¼Œåœ¨ç¨‹å¼é–‹ç™¼ä¸­ï¼Œä½ æœ‰æ²’æœ‰é‡éä¸‹é¢é€™ç¨®å•é¡Œå‘¢ ? 

> æˆ‘å’Œ A è¦ api ä¾†ä½¿ç”¨ï¼Œä½†ç™¼è¦ºå®ƒçš„ api æˆ‘éœ€è¦èª¿æ•´éå¾Œæ‰èƒ½ä½¿ç”¨ã€‚

æ‰€ä»¥é€šå¸¸ä½ é€™æ™‚ï¼Œæ‡‰è©²ä¸­é–“æœƒæœ‰ä¸€å€‹æ±è¥¿ï¼Œä¾†å‘¼å«é€™éš» api ï¼Œç„¶å¾Œå†è£¡é¢å…ˆæ•´ç†ä¸€ä¸‹ï¼Œç„¶å¾Œæ‰å‚³å‡ºå»çµ¦ä¸»è¦çš„æ–¹æ³•ä¾†ä½¿ç”¨ï¼Œå°å§ ? é€™æ™‚é‚£ä¸­é–“çš„æ±æ±å°±æ˜¯æ‰€è¬‚çš„`adapter`å®ƒæœ¬èº«å°±æ˜¯ä¸€ç¨®è¨­è¨ˆæ¨¡å¼ã€‚

 å¥½å›ä¾†åˆ°`socket.io-adapter`ï¼Œé‚£æˆ‘å€‘çš„æ’é ­å’Œæ©Ÿå™¨å„ä»£è¡¨ä»€éº¼å‘¢ ? å…ˆä¾†èªªèªªæ©Ÿå™¨ï¼Œæ©Ÿå™¨å°±æ˜¯æˆ‘å€‘çš„ socket.io é‚£æ’é ­å‘¢ ? åš´æ ¼ä¾†èªªæ˜¯`å„²å­˜ç©ºé–“`ï¼Œå„²å•¥å‘¢ ? å°±æ˜¯`namespaceã€roomsã€sids`é€™äº›æ±æ±ã€‚

`socket.io-adapter`é è¨­æ˜¯å­˜æ”¾åœ¨è¨˜æ†¶é«”ä¹‹å…§ï¼Œæ‰€ä»¥å¦‚æœä½ è¦ç”¨ redis æˆ– mq ä¹‹é¡çš„ä¾†åšå„²æ”¾ï¼Œä½ å°±åªè¦èª¿æ•´ä½ çš„ adapter å°±å¥½ï¼Œç›®å‰å®˜æ–¹æœ‰æä¾›`socket.io-redis`å¯ä½¿ç”¨ï¼Œå®ƒä¹Ÿæ˜¯ä¸€å€‹ adapterã€‚

åŸºæœ¬ä¸Šä½ è¦é€²è¡Œä»»ä½• socket.io æä¾›çš„ emitã€broadcastã€join room é€™äº›åŠŸèƒ½ï¼Œéƒ½ä¸€å®šæœƒåˆ°é€™ä¸€å±¤ä¾†åšè™•ç†ã€‚

## socket.io-client

é€™å€‹æ±æ±å°±æ˜¯è®“æˆ‘å€‘åœ¨å‰ç«¯ä½¿ç”¨çš„æ±è¥¿ï¼Œå‡è¨­æˆ‘å€‘åœ¨å¾Œç«¯ server å»ºç«‹å¥½å–”ï¼Œæˆ‘å€‘å°±å¯ä»¥å¦‚ä¸‹é¢é€™æ¨£ï¼Œé€£å»ºç«‹é€£ç·š : 

```html
<script src="/socket.io/socket.io.js"></script>
<script>
  var socket = io('http://localhost');
  socket.on('connect', function(){});
  socket.on('event', function(data){});
  socket.on('disconnect', function(){});
</script>

```
ç„¶å¾Œå¦‚æœä½ åœ¨å¾Œç«¯è¦å¯«æ•´åˆæ¸¬è©¦æ™‚ï¼Œæƒ³è¦æ¨¡æ“¬å‰ç«¯ï¼Œä¹Ÿå¯ä»¥å¦‚ä¸‹ä½¿ç”¨ : 

```js
var socket = require('socket.io-client')('http://localhost');
socket.on('connect', function(){});
socket.on('event', function(data){});
socket.on('disconnect', function(){});
```

é€™é‚Šé‚„æœ‰ä¸€å€‹é‡é»ï¼Œå®ƒèˆ‡ socket.io ä¸€æ¨£æ ¸å¿ƒéƒ½æ˜¯`engine.io-client`ä¸¦ä¸”ä¹Ÿæ˜¯ç”±å®ƒä¾†æ±ºå®šæˆ‘å€‘è¦ç”¨ä»€éº¼å‚³è¼¸æ–¹å¼(pollingã€websocket)ã€‚

## socket.io-protocol
æœ€å¾Œæ˜¯`socket.io-protocol`ï¼Œé€™å€‹äº‹å¯¦ä¸Šä¸Šé¢æœ‰èªªæ˜éäº†ï¼Œæˆ‘å€‘åœ¨ä¾†è¤‡ç¿’ä¸€æ¬¡ã€‚

å®ƒæ˜¯å€‹å”å®šï¼Œå®ƒä¸æ˜¯ç¨‹å¼ç¢¼ã€å¥—ä»¶æˆ–å…¶å®ƒå¯ä»¥åŸ·è¡Œçš„æ±è¥¿ï¼Œ`å®ƒæ˜¯ä¸€å€‹è¦å®š`ï¼Œå®ƒå®šè­°å¥½socket.io è¦å¦‚ä½•çš„å‚³è¼¸è³‡æ–™ï¼Œå®ƒä¸»è¦å®šç¾©äº†ä»¥ä¸‹äºŒå€‹ä¸»é¡Œ : 

### Parser API
`Parser API`ä¸Šé¢æœ‰æåˆ°ï¼Œå®ƒæ˜¯ç”¨ä¾†å°‡ packet åŒ…é€²è¡Œ encode èˆ‡ decode çš„æ±æ±ï¼Œåœ¨ protocol ä¸­ï¼Œå®ƒå¯¦éš›å®šç¾©ä¸€å€‹ parser api éœ€è¦æœ‰é‚£äº›æ±è¥¿ã€‚

ä¸‹é¢ç‚ºå®ƒçš„ä¸»è¦å®šç¾©

* Encoder.encode(Object: packet, Function: callback)
* Decoder.add(Object:encoding)

`Encoder`å°±æ˜¯ç”¨ä¾†é€²è¡Œ encode çš„é¡åˆ¥ï¼Œç„¶å¾Œå®ƒéœ€è¦æä¾›`encode`æ–¹æ³•ï¼Œä¸¦ä¸”æœ‰å…©å€‹åƒæ•¸åˆ†åˆ¥ç‚º`packet å’Œ callback`ã€‚

è€Œ`Decoder`å°±æ˜¯è¦å°‡ packet é€²è¡Œ decod æœƒé¡åˆ¥ï¼Œä¸¦ä¸”éœ€è¦æœ‰å€‹`add`æ–¹æ³•ï¼Œä¾†é€²è¡Œè™•ç†ã€‚

åƒæˆ‘å€‘ä¸Šé¢æåˆ°çš„`socket.io-parser`å°±æ˜¯æ ¹æ“š`socket.io-protocol`æ‰€å®šç¾©çš„`parser api`å¯¦ä½œå‡ºçš„ç¨‹å¼ç¢¼ã€‚

```js
var parser = require('socket.io-parser');
var encoder = new parser.Encoder();
var packet = {
  type: parser.EVENT,
  data: 'test-packet',
  id: 13
};
encoder.encode(packet, function(encodedPackets) {
  var decoder = new parser.Decoder();
  decoder.on('decoded', function(decodedPacket) {
    // decodedPacket.type == parser.EVENT
    // decodedPacket.data == 'test-packet'
    // decodedPacket.id == 13
  });

  for (var i = 0; i < encodedPackets.length; i++) {
    decoder.add(encodedPackets[i]);
  }
});
``` 

### Packet

`Packet`æ˜¯`socket.io`ä¸–ç•Œè£¡çš„æºé€šåŒ…åŒ…ï¼Œåƒä½ å¦‚æœè¦æ”¾é€è¨Šæ¯æˆ–æ˜¯é€²è¡Œ connect æ™‚ï¼Œå®ƒå€‘éƒ½æ˜¯å‚³é€çš„éƒ½æ˜¯`packet`ã€‚

åœ¨ protocol ä¸­ï¼Œå®ƒå®šç¾©å¥½äº†ï¼Œä¸€å€‹ packet è¦é•·ä»€éº¼æ¨£å­ : 

```
{
    type: Number,
    data: [],
    id: Number,
}
```

#### type

å°±æ˜¯ç”¨ä¾†æ±ºå®šï¼Œé€™å€‹åŒ…æ˜¯è¦åšä»€éº¼äº‹æƒ…ï¼Œprotocol å®ƒå®šç¾©äº†ä»¥ä¸‹å¹¾ç¨®é¡å‹ : 

* CONNECT(0)
* DISCONNECT(1)
* EVENT(2)
* ACK(3)
* ERROR(4)
* BINARY_EVENT(5)
* INARRY_ACK(6)

#### data
å°±æ˜¯ä½ é€™å€‹åŒ…å‚³é€çš„è³‡è¨Šï¼Œå®ƒå¸¸éƒ½æ˜¯æˆ‘å€‘è‡ªå·²çš„ï¼Œä¸éè¨˜å¥½ï¼Œå®ƒæ˜¯è¦æ”¾æˆä¸€å€‹é™£åˆ—ã€‚

#### id
ç”¨ä¾†è­˜åˆ¥é€™å€‹åŒ…æ˜¯èª°çš„ï¼Œéœ€è¦æ™‚åœ¨è¨­å®šã€‚

## ç¸½çµ

æœ€å¾Œæˆ‘å€‘ä¾†ä½¿ç”¨ä¸‹é¢é€™å¼µåœ–ï¼Œä¾†ç¸½çµä¸€ä¸‹ socket.io é€™å€‹ framework çš„æ¶æ§‹ : 

![](http://yixiang8780.com/outImg/20171011-1.png)

ä¸Šåœ–ç‚º socket.io çš„æ•´é«”æ¶æ§‹ï¼Œæˆ‘å€‘æœ€å¾Œä¾†è¤‡ç¿’ä¸€æ¬¡ã€‚

é¦–å…ˆæœ€ä¸»è¦çš„ä¸»é«”ç‚º`engino.io`ï¼Œæ‰€æœ‰çš„é€£ç·šã€å‚³è¼¸æ–¹å¼çš„æ ¸å¿ƒéƒ½æ˜¯ä»–ï¼Œç„¶å¾Œç•¶ä½ æƒ³è¦èˆ‡å…¶å®ƒæ±è¥¿é€²è¡Œæºé€šæ™‚ï¼Œå®ƒå€‘çµ±ä¸€çš„æºé€šå…ƒä»¶`packet`éƒ½éœ€è¦ä½¿ç”¨`socket.io-parser`ä¾†é€²è¡Œ encode èˆ‡ decode ï¼Œå› ç‚ºæŸäº›å‚³è¼¸æ–¹å¼ websocket åªèƒ½ç”¨æ–‡å­—èˆ‡äºŒé€²ä½æ•¸æ“šï¼Œé‚„æœ‰é€™äº›å®šç¾©éƒ½æœƒå¯«åœ¨ `socket.io-protocol`è£¡é¢ï¼Œæœ€å¾Œå¦‚æœæƒ³ä½ è¦èˆ‡å„²å­˜å…ƒä»¶æºé€šï¼Œè«‹å»ºç«‹ä¸€å€‹ `adapter` ä¾†è™•ç†ã€‚

## åƒè€ƒè³‡æ–™
* [Socket.io Github](https://github.com/socketio)
