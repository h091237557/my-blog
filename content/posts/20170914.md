---
title: "Socket.io çš„èªªè©±å³¶"
date: 2017-09-14T19:51:35+08:00
draft: false
tags: 
- instant messaging  
- socket.io
keywords:
- socket 
- socket.io
---

socket io æ˜¯ nodejs æ‰€æä¾›çš„å¥—ä»¶ï¼Œå®ƒä¸»è¦å¯ä»¥åšçš„äº‹æƒ…å°±æ˜¯`æ¨æ’­åŠŸèƒ½`ã€‚

ä½ æƒ³æƒ³ï¼Œå‡è¨­ä½ è¦åšå€‹è‚¡ç¥¨å ±åƒ¹ç¶²ç«™ï¼Œç„¶å¾Œç•¶ä½ å¾Œç«¯æ”¶åˆ°æ–°çš„è‚¡åƒ¹æ™‚ï¼Œä½ è¦å¦‚ä½•çš„é€åˆ°å‰ç«¯ ?
åœ¨å‚³çµ±çš„ server èˆ‡ client æ¶æ§‹ä¸‹ï¼Œå› ç‚ºåªèƒ½ç”± client å‘ server ç™¼å‡ºè«‹æ±‚ï¼Œè€Œä¸èƒ½ç”± server ç™¼é€æ–°çš„è¨Šæ¯åˆ° clientï¼Œæ‰€ä»¥ç•¶æ™‚çš„äººå€‘çš„è§£æ±ºæ–¹æ¡ˆå°±æ˜¯`è¼ªè©¢`ï¼Œå›ºåæ€æ„å°±æ˜¯æŒ‡å®šæ™‚çš„å» server æ‰¾è³‡æ–™ã€‚

ä½†é€™ç¨®æ–¹æ¡ˆæœ‰ç¼ºé»ï¼Œä½ æƒ³æƒ³ï¼Œä½ æœ‰å¯èƒ½å» server æŠ“ 10 æ¬¡è³‡æ–™ï¼Œå®ƒæœ‰å¯èƒ½ 10 æ¬¡éƒ½æœ‰æ–°çš„è³‡æ–™å— ? ä¸ä¸€å®šå°å§ ? æ‰€ä»¥æœ€ç†æƒ³çš„æ–¹æ¡ˆä¸€å®šæ˜¯å¾ server ç«¯æœ‰æ–°è³‡æ–™å°±è‡ªå‹•æ¨é€åˆ° client ç«¯ã€‚

`websocket`å°±æ˜¯ä¸€å€‹ç”± html 5 æ‰€ç™¼å¸ƒçš„æ–°å”è­°ï¼Œå®ƒå°±å¯ä»¥åšåˆ°ä¸Šé¢æ‰€éœ€è¦çš„åŠŸèƒ½ã€‚

é‚£`socket.io`æ˜¯å•¥ ? å®ƒæ˜¯æœƒæ ¹æ“šä½ çš„ client æ‰€æ”¯æ´çš„åŠŸèƒ½(websocketã€cometã€é•·è¼ªè©¢â€¦)ä¾†æ±ºå®šä½ å¾Œç«¯è¦å¦‚ä½•çš„ç™¼é€è³‡æ–™ï¼Œæ›´ç™½è©±æ–‡çš„èªªï¼Œä½ ä¸ç”¨ç®¡ä½ çš„ client æœ‰æ²’æœ‰æ”¯æ´ websocketï¼Œsocket.io ä¸€åˆ‡éƒ½è‡ªå‹•æœƒè™•ç†å¥½ï¼Œä½ åªè¦å’Œæˆ‘èªªå•¥æ™‚è¦é€è³‡è¨Šåˆ°å‰ç«¯å°±å°äº†ã€‚ 


## Socket.io çš„çµ„æˆ

è«‹åƒè€ƒç­†è€…çš„é€™ç¯‡æ–‡ç« ã€‚

[Socketio çš„æ¶æ§‹](http://marklin-blog.logdown.com/posts/2906519)

## ç°¡å–® client èˆ‡ server çš„æºé€šç¯„ä¾‹

server ç«¯ç¨‹å¼ç¢¼å¦‚ä¸‹ï¼Œé€™æ®µç¨‹å¼ç¢¼ç•¶èˆ‡ client ç«¯å»ºç«‹ä¸€æ¢ websocket é€£ç·šå¾Œï¼Œæœƒç›´æ¥å°è©²æ¢é€£ç·šå‚³é€å€‹`{hello: "world"}`è¨Šæ¯ã€‚

```js
var io = require('socket.io').listen(8080);

io.sockets.on('connection', function (socket) {
    socket.emit('news', { hello: 'world' });
    socket.on('my other event', function (data) {
        console.log(data);
    });
});
```
å‰ç«¯ :

```js
<script src="/socket.io/socket.io.js"></script>
<script>
    var socket = io.connect('http://localhost:8080');
    socket.on('news', function (data) {
        console.log(data);
        socket.emit('my other event', { my: 'data' });
    });
</script>
```

é€™æ¨£å°±å¯ä»¥å®Œæˆç°¡å–®çš„æ¨æ’­åŠŸèƒ½å›‰ã€‚

## Socket.io çš„ Rooms èˆ‡ Namespaces

åœ¨ socket.io æœ‰å…©å€‹å¾ˆé‡è¦çš„æ¦‚å¿µ`rooms`èˆ‡`namespaces`ï¼Œé€™é‚Šä½ åªéœ€è¦è¨˜å¥½ä¸€ä»¶äº‹ï¼Œé‚£å°±æ˜¯å®ƒå€‘å…©å€‹å­˜åœ¨çš„åŸå› éƒ½æ˜¯ç‚ºäº†`åˆ†çµ„`ï¼ŒæŠŠè¦å‚³é€çš„è¨Šæ¯ï¼Œé€åˆ°ä½ æƒ³è¦çš„ç¾¤çµ„ä¸­ã€‚

### Namespaces

æˆ‘å€‘å…ˆçœ‹çœ‹`namespaces`ï¼Œä¸Šé¢çš„ç¯„ä¾‹ä¸­æœ‰æ²’æœ‰æ³¨æ„åˆ°ï¼Œæˆ‘å€‘éƒ½æ˜¯ç”¨`io`ä¾†é€²è¡Œæ‰€æœ‰çš„æ“ä½œï¼Œå‡è¨­æˆ‘å€‘è¦æ”¾é€è¨Šæ¯åˆ°æ‰€æœ‰é€£ç·šçš„ socketï¼Œé‚£æˆ‘å€‘åªè¦ä¸‹é”è©²æŒ‡ä»¤ : 

```js
io.emit('news', 'Hi I am Mark')
``` 

æ¥ä¸‹ä¾†ç„¶å¾Œæˆ‘å€‘ä¹Ÿå¯ä»¥ä½¿ç”¨ rooms ä¾†å°‡ io è£¡é¢çš„ socket åˆ†é¡åˆ°ä¸åŒçš„æˆ¿é–“ä¸­ï¼Œæ‰€ä»¥ç•¶æˆ‘å€‘è¦å‚³é€æŒ‡å®šçš„è¨Šæ¯åˆ°æŸå€‹æˆ¿é–“ä¸­åªè¦ä¸‹é”ä¸‹é¢çš„æŒ‡ä»¤ :

```js
io.to('å…¨å®¶å°±æ˜¯æˆ‘å®¶').emit('news', 'Hi I am Mark')
```

é‚£é€™é‚Šæˆ‘æƒ³å•å•ï¼Œæœ‰æ²’æœ‰è¾¦æ³•å»ºç«‹å¦ä¸€å€‹ io å‘¢ ? ä¾‹å¦‚æˆ‘æƒ³å»ºç«‹ä¸€å€‹æ˜¯å°ˆé–€è™•ç†è‚¡ç¥¨çš„ io ï¼Œè€Œå¦ä¸€å€‹æ˜¯å°ˆé–€è™•ç†æœŸè²¨çš„ io ï¼Œé€™æ™‚æˆ‘å€‘å°±å¯ä»¥ä½¿ç”¨`namespaces`è£¡çš„`of`é€™æ–¹æ³•ä¾†è™•ç†ã€‚

ä¾‹å¦‚æˆ‘å€‘å…ˆä¾†å»ºç«‹ä¸€å€‹è‚¡åƒ¹çš„ namespaces : 

```js
var stock_io = io.of('/stock');
```

ç„¶å¾Œæˆ‘å€‘å°±å¯ä»¥ä½¿ç”¨é€™å€‹`stock_io`ä¾†é€²è¡Œæˆ‘å€‘ä¸Šé¢æåˆ°çš„æ‰€æœ‰å‹•ä½œã€‚

> namespaces ä½ å¯ä»¥æƒ³æˆï¼Œ å­ io ï¼Œå®ƒå¯ä»¥åšæ‰€æœ‰ io å¯ä»¥åšçš„äº‹æƒ… (åŸºæœ¬ä¸Š)

### Room
æ¥ä¸‹ä¾†æˆ‘å€‘ä¾†èªªèªª`rooms`ï¼Œé€™æ±æ±çš„æ¦‚å¿µå’Œ`namespace`äº‹å¯¦ä¸Šå¾ˆåƒï¼Œä½†è¨˜å¥½ï¼Œ`rooms æ˜¯åœ¨ namespaces åº•ä¸‹çš„`ã€‚

å‡è¨­ä½ æœ‰ä¸€å€‹éœ€æ±‚ï¼Œæœ‰3å€‹ç”¨æˆ¶åœ¨ç”¨ä½ çš„è‚¡åƒ¹å ±åƒ¹ç³»çµ±ï¼Œå…¶ä¸­å…©å€‹æ˜¯åœ¨çœ‹ 1101 å°æ³¥çš„è‚¡åƒ¹ï¼Œè€Œå…¶ä¸­ä¸€å€‹æ˜¯åœ¨çœ‹ 2330 å°ç©é›» çš„è‚¡åƒ¹ï¼Œé€™æ™‚ä½ æ‡‰è©²è¦æ³¨æ„ï¼Œä¸èƒ½å°‡ 2330 çš„è‚¡åƒ¹æ¨åˆ°åœ¨çœ‹ 1101 è‚¡åƒ¹çš„ä½¿ç”¨è€…é‚£ã€‚

socket.io çš„ rooms çš„åŠŸèƒ½å°±å¯ä»¥è§£æ±ºä¸Šé¢çš„éœ€æ±‚ï¼Œ`rooms`çš„åŠŸèƒ½ç™½è©±æ–‡å°±æ˜¯ä½ å¯ä»¥`ç™¼é€è¨Šæ¯åˆ°æŒ‡å®šçš„æˆ¿é–“`ï¼Œåƒ 1101 å°±æ˜¯ä¸€å€‹æˆ¿é–“ï¼Œè€Œ 2330 å°±æ˜¯å¦ä¸€å€‹æˆ¿é–“ï¼Œæ‰€ä»¥å‡è¨­æœ‰ 1101 çš„è¨Šæ¯è¦æ¨é€ï¼Œåªè¦é‡å°è©² room çš„ç”¨æˆ¶é€²è¡Œæ¨é€å°±å¤ äº†ã€‚

#### é‚£è¦å¦‚ä½•åŠ å…¥åˆ°æˆ¿é–“å‘¢ ? 
å¦‚ä¸‹ :

```
io.on('connection', function(socket){
  socket.join('1101');
});
```

#### é‚£è¦å¦‚ä½•å‚³é€è¨Šæ¯åˆ°æŒ‡å®šçš„æˆ¿é–“å‘¢ ? 

å¦‚ä¸‹åœ’å¼ç¢¼ï¼Œä½ å°±å¯ä»¥ç™¼é€è¨Šæ¯åˆ°é€™å€‹æˆ¿é–“è£¡ã€‚æ³¨æ„é€™é‚Šæ˜¯ç”¨`io`ä¾†ç™¼é€è¨Šæ¯ï¼Œä¸Šé¢ç°¡å–®çš„ç¯„ä¾‹æ˜¯ç”¨`socket.emit`ä¾†é€æ˜¯å› ç‚ºä¸Šé¢ç¯„ä¾‹åªéœ€è¦ç™¼é€è¨Šæ¯çµ¦é‚£æ¢ socket é€£ç·šå°±å¥½ï¼Œè€Œé€™é‚Šæˆ‘å€‘æ˜¯è¦ç™¼é€çµ¦`1101 é€™å€‹ room`ä¸­çš„ socketï¼Œæ‰€ä»¥è¦ç”¨`io`ä¾†ç™¼é€ã€‚

```
 io.to('1101').emit('xxxxè‚¡åƒ¹')
```

### é€™å…©å€‹çš„å·®åˆ¥

æœ€å¾Œçµ‚çµä¸€ä¸‹é€™å…©å€‹çš„å·®åˆ¥

> ä½ å¯ä»¥æŠŠ namespace çš„åŠŸèƒ½æƒ³æˆå¯ä»¥å»ºç«‹å¤šå€‹å­ io ï¼Œä¸åŒçš„å­ io å¯ä»¥è™•ç†è‡ªå·²çš„äº‹æƒ…ï¼Œä¹Ÿä»£è¡¨æœ‰è‡ªå·²çš„ rooms ï¼Œio1 èˆ‡ io2 å…©å€‹å¦‚æœéƒ½æœ‰ room ç‚º movie çš„ï¼Œä¹Ÿä¸æœƒå½±éŸ¿åˆ°ä»€éº¼ï¼Œå› ç‚ºå®ƒå€‘æ˜¯åˆ†å±¬ä¸åŒçš„ io äº†ã€‚

## åœ¨ Socket.io ä¸­ä½¿ç”¨ middleware

åœ¨å¹³å¸¸æˆ‘å€‘ web é–‹ç™¼æ™‚ï¼Œæœ‰æ™‚å¾Œæœƒæœ‰ä¸‹é¢é€™ç¨®éœ€æ±‚ : 

> æ¯ä¸€å€‹ http è«‹æ±‚é€²ä¾†å‰ï¼Œéœ€è¦å…ˆæª¢æŸ¥ç™»å…¥ç‹€æ…‹

é€šå¸¸é€™ç¨®æ™‚å¾Œæˆ‘å€‘å°±æœƒå»ºç«‹ä¸€å€‹ middleware ä¾†è™•ç†ç™»å…¥ç‹€æ…‹ï¼Œé€™é‚Šè¦æ³¨æ„ middleware ä¸æ˜¯ç”¨ä¾†å°ˆé–€è™•ç†ç™»å…¥çš„æ±æ±ï¼Œå®ƒåªæ˜¯ä¸€å€‹æ¦‚å¿µï¼Œå®ƒçœŸæ­£çš„å®šç¾©å¦‚ä¸‹ :

> middleware åˆç¨±ä¸­ä»‹å±¤ï¼Œç”¨ä¾†è™•ç†æ‰€æœ‰é€²å…¥æˆ–é›¢é–‹`ä¸»é«”`å‰çš„äº‹å‹™ã€‚

åƒæˆ‘å€‘æ¯å€‹ http è«‹æ±‚é€²åˆ°ä¸»é«”å‰ï¼Œæˆ‘å€‘éœ€è¦å…ˆç¢ºèªå®ƒçš„ç‹€æ…‹ï¼Œåˆæˆ–è€…æ˜¯é€²åˆ°ä¸»é¡Œå‰å°±å…ˆå°‡ log å¯«å¥½ï¼Œé€™äº›éƒ½æ˜¯å¯ä»¥æ”¾ç½®åˆ°`middleware`ä¾†è™•ç†ï¼Œä½ åªè¦è¨˜å¥½ï¼Œä¸»é«”å°±åªåšä¸»é«”è¦åšçš„äº‹æƒ…å°±å¥½ã€‚

ç•¶ç„¶åœ¨ socket.io ä¸­æˆ‘å€‘ä¹Ÿæ˜¯æœ‰é€™å€‹éœ€æ±‚ï¼Œä¾‹å¦‚æ¯ç•¶è¦å»ºç«‹ websocket é€£ç·šæ™‚ï¼Œè¦é å…ˆè™•ç†çš„äº‹æƒ…ï¼Œæˆ‘å€‘éƒ½å¯ä»¥å»ºç«‹ middleware ä¾†è™•ç†ã€‚

socket.io æä¾›`use`æ–¹æ³•ä¾†è®“æˆ‘å€‘å»ºç«‹ middleware ï¼Œç¯„ä¾‹ç¨‹å¼ç¢¼å¦‚ä¸‹ : 

```js
var srv = require('http').createServer();
var io = require('socket.io')(srv);
var run = 0;
io.use(function(socket, next){
  run++; // 0 -> 1
  next();
});

var socket = require('socket.io-client')();
socket.on('connect', function(){
  // run == 2 at this time
});

```
åƒä¸Šé¢çš„å®˜æ–¹ç¨‹å¼ç¢¼ä¸­ï¼Œä¸‹é¢é€™æ®µå°±æ˜¯ midddleware çš„ä½¿ç”¨æ–¹æ³•ï¼Œè£¡é¢çš„ use å°±æ˜¯ä¸€å€‹ middleware æ–¹æ³•ï¼Œåœ¨å»ºç«‹ websocket å‰æœƒå…ˆè™•ç†çš„äº‹æƒ…ã€‚

```js
io.use(function(socket, next){
  run++; // 0 -> 1
  next();
});
```

æ‰€ä»¥å‡è¨­æˆ‘å€‘éœ€è¦å…ˆè™•ç†`log äº‹å‹™`èˆ‡`å¿«å–äº‹å‹™`æ™‚ï¼Œæˆ‘å€‘ç¨‹å¼ç¢¼å°±å¤§æ¦‚æœƒé•·å¦‚ä¸‹ : 

```js
io.use(logMiddleWare);
io.use(cacheMiddleWare);

function logMiddleWare(socket, next){
    å¯« log ~~~
    next();
}

function cacheMiddleWare(socket, next){
    å–å¾—æš«å­˜è³‡æ–™.....
    next();
}

```

## åƒè€ƒè³‡æ–™

 * [SOCKETIO å®˜ç¶²](https://socket.io/docs/server-api/)

