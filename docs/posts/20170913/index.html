<!DOCTYPE html>
<html>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-154360458-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-154360458-1');
</script>
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
  Socket.io çš„æ¶æ§‹ &ndash; æ‹¿éµæ´¾çš„é¦¬å…‹ Blog

    </title>
    
    <meta content="socket, socket.io" name="keywords">
    
    
    <meta name="description" property="og:description" content="socket.io æ˜¯ node js çš„ä¸€å€‹ frameworkï¼Œå®ƒå¯ä»¥å¹«åŠ©æˆ‘å€‘å»ºç«‹èŠå¤©å®¤é€™ç¨®æ¨æ’­åŠŸèƒ½çš„ç³»çµ±ï¼Œé€™ç¯‡æ–‡ç« æˆ‘å€‘ä¸æœƒèªªæ˜å®ƒå¦‚ä½•ä½¿ç”¨ï¼Œè€Œæ˜¯è¦ç†è§£ socket.io é€™å€‹å¥—ä»¶çš„æ¶æ§‹çµ„æˆ|Describe what your web page is about">
    

    <meta name="apple-mobile-web-app-title" content="æ‹¿éµæ´¾çš„é¦¬å…‹ Blog">
    
    
    <link rel="icon" href="/favicon-64.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="mask-icon" size="any" href="/pinned-icon.svg">
    
    
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@your_twitter_id">
    <meta name="twitter:creator" content="@your_twitter_id">
    <meta name="twitter:title" content="Socket.io çš„æ¶æ§‹ | æ‹¿éµæ´¾çš„é¦¬å…‹ Blog">
    <meta name="twitter:description" content="socket.io æ˜¯ node js çš„ä¸€å€‹ frameworkï¼Œå®ƒå¯ä»¥å¹«åŠ©æˆ‘å€‘å»ºç«‹èŠå¤©å®¤é€™ç¨®æ¨æ’­åŠŸèƒ½çš„ç³»çµ±ï¼Œé€™ç¯‡æ–‡ç« æˆ‘å€‘ä¸æœƒèªªæ˜å®ƒå¦‚ä½•ä½¿ç”¨ï¼Œè€Œæ˜¯è¦ç†è§£ socket.io é€™å€‹å¥—ä»¶çš„æ¶æ§‹çµ„æˆ|Describe what your web page is about">
    <meta name="twitter:image" content="https://mark-lin.comtwitter-card.png">
    


    <link rel="stylesheet" href="/assets/syntax-1.0.css">
    <link rel="stylesheet" href="/assets/primer-build.css">
    <link rel="stylesheet" href="/assets/style-1.3.css">
  </head>


  <body>
        <div id="header" class="px-1 bg-white">
                <nav class="UnderlineNav--right px-2 container-lg">
  <div class="logo">
      <a class="log-main UnderlineNav-actions" href="https://mark-lin.com">
          æ‹¿éµæ´¾çš„é¦¬å…‹ Blog
        </a>
      <span class="logo-small">äººç”Ÿå°±æ˜¯è¦æ…¢æ…¢çš„å–æ‹¿éµ ~ æ‹¿éµæ‰æ˜¯ç‹é“</span>
  </div>


  
  
</nav>

              </div>
    <div id="holy" class="container-lg bg-white h-100">



      <div role="main" id="main" class="holy-main markdown-body px-4">
        




<div class="Subhead">
  <div class="Subhead-heading">
    <div class="h1 mt-3 mb-1">Socket.io çš„æ¶æ§‹</div>
  </div>
  <div class="Subhead-description">
    




<a href='/tags/instant-messaging' class="muted-link">
  <span class="Label Label--gray">instant messaging</span>
</a>

<a href='/tags/socket.io' class="muted-link">
  <span class="Label Label--gray">socket.io</span>
</a>



    
    <div class="float-md-right">
      <span title="Lastmod: 2019-12-15. Published at: 2017-09-13.">
        
          Lastmod: 2019-12-15
        
      </span>
    </div>
    
  </div>
</div>
<article>
  
  <section class="pb-6 mb-3 border-bottom">
    <p>socket.io æ˜¯ node js çš„ä¸€å€‹ frameworkï¼Œå®ƒå¯ä»¥å¹«åŠ©æˆ‘å€‘å»ºç«‹èŠå¤©å®¤é€™ç¨®æ¨æ’­åŠŸèƒ½çš„ç³»çµ±ï¼Œé€™ç¯‡æ–‡ç« æˆ‘å€‘ä¸æœƒèªªæ˜å®ƒå¦‚ä½•ä½¿ç”¨ï¼Œè€Œæ˜¯è¦ç†è§£ socket.io é€™å€‹å¥—ä»¶çš„æ¶æ§‹çµ„æˆã€‚</p>
<p>socket.io ä¸»è¦ç”±ä»¥ä¸‹å¹¾å€‹æ±æ±æ§‹æˆçš„ :</p>
<ul>
<li>engine.ioã€engino.io-client</li>
<li>socket.io-parser</li>
<li>socket.io-adapter</li>
<li>socket.io-client</li>
<li>socket.io-protocol</li>
</ul>
<p>æ¥ä¸‹ä¾†æˆ‘å€‘å°‡ä¸€å€‹ä¸€å€‹èªªæ˜å®ƒå€‘æ˜¯åšå•¥ç”¨çš„ï¼Œä¸¦ä¸”æœ€å¾Œæœƒåœ¨é€²è¡Œä¸€å€‹ç¸½çµã€‚</p>
<h2 id="engineio">engine.io</h2>
<p><code>engine.io</code>æ˜¯ä¸€å€‹å¯¦éš›åŸ·è¡Œ socket.io é€šè¨Šå±¤ç´šçš„ libaryï¼Œåš´æ ¼èªªèµ·ä¾†ï¼Œ<code>socket.io çš„æ ¸å¿ƒå°±æ˜¯engine.io</code>ï¼Œæ‰€æœ‰çš„å»ºç«‹é€£ç·šã€å‚³è¼¸è³‡è¨Šå¯¦éš›ä¸Šéƒ½æ˜¯ç”±å®ƒä¾†åšï¼Œä¸¦ä¸”æ ¹æ“šå‰ç«¯å‚³é€å›ä¾†çš„è³‡è¨Šï¼Œä¾†æ±ºå®šä½¿ç”¨ä»€éº¼å‚³è¼¸æ–¹å¼ã€‚</p>
<p>ç›®å‰ engine.io æ‰€æä¾›çš„æºé€šæ–¹å¼æœ‰ä»¥ä¸‹å¹¾ç¨® :</p>
<ul>
<li>polling-jsonp</li>
<li>polling-xhr</li>
<li>pollin</li>
<li>websocket</li>
</ul>
<p>ä¸Šé¢æœ‰æåˆ°ï¼Œsocket.io æœ¬èº«ä¸æä¾›é€£ç·šåŠŸèƒ½ï¼Œè€Œæ˜¯åœ¨ engine.io æ‰æä¾›ï¼Œæ‰€ä»¥äº‹å¯¦ä¸Šï¼Œå¦‚æœä½ æ²’æœ‰ä¸€å®šè¦ä½¿ç”¨åˆ° socket.io çš„åŠŸèƒ½ï¼Œè€Œåªæ˜¯è¦é€£ç·šåˆ° http server æˆ–æ˜¯ç›£è½ port çš„è©±ï¼Œåªè¦ç”¨ engine.io å°±å¤ äº†ï¼Œé€™é‚Šæœ‰å€‹é‡é»è¦è¨˜å¾— socket.io æ˜¯å€‹ framework è€Œ engine.io åªæ˜¯å€‹ libaryï¼Œåªè¦åˆ†çš„å‡ºé€™å…©å€‹å·®åˆ¥ï¼Œä½ å°±å¯ä»¥è‡ªç”±çš„é¸ä½ è¦çš„ä½¿ç”¨ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">engine</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;engine.io&#39;</span><span class="p">)</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span><span class="p">;</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="p">{</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;utf 8 string&#39;</span><span class="p">)</span><span class="p">;</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span><span class="p">)</span><span class="p">)</span><span class="p">;</span> <span class="c1">// binary data
</span><span class="c1"></span><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</code></pre></div><h2 id="enginoioclient">engino.io-client</h2>
<p><code>engine.io-client</code>æ˜¯<code>socket.io-client</code>çš„æ ¸å¿ƒï¼Œæ‰€æœ‰é—œéµçš„é€£ç·šã€é¸æ“‡å‚³è¼¸æ–¹å¼ï¼Œéƒ½æ˜¯åœ¨é€™è£¡é¢åŸ·è¡Œã€‚</p>
<p>æˆ‘å€‘é€™è£¡ä¾†çœ‹çœ‹ï¼Œå®ƒæ˜¯å¾é‚£æ±ºå®šè¦ç”¨é‚£ç¨®çš„<code>å‚³è¼¸æ–¹å¼</code>(websocketã€polling)ã€‚</p>
<p>åœ¨<code>engine.io-client</code>ä¸‹é¢é€™æ®µç¨‹å¼ç¢¼(<a href="https://github.com/socketio/engine.io-client/blob/master/lib/socket.js#L405">ç¨‹å¼ç¢¼å‚³é€é–€</a>)ä¸­ ï¼Œé€™æ®µ<code>onOpen</code>æ˜¯åœ¨ socket è¦èˆ‡ server é€²è¡Œé€£ç·šæ™‚ï¼Œæœƒå…ˆåŸ·è¡Œçš„äº‹ä»¶ï¼Œå…¶ä¸­ï¼Œå°±æ˜¯ç”±<code>this.probe(this.upgrades[i])</code>é€™å€‹æ–¹æ³•ä¾†æ±ºå®šè¦ç”¨ä»€éº¼æ–¹å¼(websocketã€polling)ä¾†é€²è¡Œå‚³è¼¸ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onOpen</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;socket open&#39;</span><span class="p">)</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;open&#39;</span><span class="p">;</span>
  <span class="nx">Socket</span><span class="p">.</span><span class="nx">priorWebsocketSuccess</span> <span class="o">=</span> <span class="s1">&#39;websocket&#39;</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">)</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">flush</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

  <span class="c1">// we check for `readyState` in case an `open`
</span><span class="c1"></span>  <span class="c1">// listener already closed the socket
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;open&#39;</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">upgrade</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">pause</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;starting upgrade probes&#39;</span><span class="p">)</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">upgrades</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">probe</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">upgrades</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span><span class="p">;</span>
</code></pre></div><p>ç„¶å¾Œåœ¨å¾Œç«¯ server ï¼Œä¹Ÿå°±æ˜¯<code>engine.io</code>è£¡æ ¹æ“šå‰ç«¯å‚³é€å›ä¾†çš„<code>url</code>åƒæ•¸çš„<code>Transport</code>ä¾†æ±ºå®šè¦ç”¨ä»€éº¼ä¾†é€²è¡Œå‚³è¼¸ :</p>
<pre><code>url ç¯„ä¾‹ : 

/engine.io/default/?transport=polling
</code></pre><p><code>engine.io</code>çš„ä¸‹é¢é€™æ®µç¨‹å¼ç¢¼è£¡ï¼Œ<code>check</code>ç”¨ä¾†é©—è­‰å‚³é€²ä¾†çš„åƒæ•¸æ˜¯å¦åˆæ³•ï¼Œä¾†æ±ºå®šé€™å€‹<code>transport</code>åƒæ•¸æ˜¯å¦åˆæ³•ï¼Œç„¶å¾Œå†ä¾†å°‡ http å‡ç´šç‚º websocket å”ç¾©ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;upgrade&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">head</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">check</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">handleUpgrade</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">head</span><span class="p">)</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="o">!==</span> <span class="nx">options</span><span class="p">.</span><span class="nx">destroyUpgrade</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// default node behavior is to disconnect when no handlers
</span><span class="c1"></span>        <span class="c1">// but by adding a handler, we prevent that
</span><span class="c1"></span>        <span class="c1">// and if no eio thing handles the upgrade
</span><span class="c1"></span>        <span class="c1">// then the socket needs to die!
</span><span class="c1"></span>        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">writable</span> <span class="o">&amp;&amp;</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">bytesWritten</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span><span class="p">,</span> <span class="nx">destroyUpgradeTimeout</span><span class="p">)</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</code></pre></div><h2 id="socketioparser">socket.io-parser</h2>
<p>åœ¨ socket.io çš„ä¸–ç•Œä¸­ï¼Œæœ‰ä¸€å€‹æ±è¥¿å«åš <code>packet</code>ï¼Œå®ƒæ˜¯æ‰€æœ‰æºé€šçš„åŸºç¤åŒ…ï¼Œäº‹å¯¦ä¸Šå®ƒä¹Ÿå°±æ˜¯ socket.io çš„å”è­°ï¼Œæœ‰ä¸€å€‹æ±è¥¿å«<code>socket.io-protocol</code>(<a href="https://github.com/socketio/socket.io-protocol">å‚³é€é–€</a>)ï¼Œå®ƒè£¡é¢æœ‰å®šè­°å¥½ï¼Œä½ é€™å€‹ packet è¦é•·ä»€éº¼æ¨£å­ã€‚</p>
<p>ä¸‹é¢ç‚ºæœ€ç°¡å–®çš„ packet åŒ… :</p>
<pre><code>{
    type: 2,
    data: [{
        word: &quot;hello mark&quot;
    },{
        word: &quot;hello gg&quot;
    }]
}
</code></pre><p>å…¶ä¸­<code>2</code>æ‰€ä»£è¡¨çš„ç‚ºé€™å€‹ packet æ˜¯è¦ç”¨ä¾†è™•ç†<code>event</code>äº‹ä»¶ï¼Œåƒè¦å‚³é€åˆ°å‰ç«¯çš„äº‹ä»¶ä¹Ÿæ˜¯ç”¨é€™å€‹ä»£è™Ÿï¼Œé€™å€‹æ•¸å­—æœƒç”± socket.io-protocol è£¡å®šç¾©å¥½ã€‚</p>
<p>ç„¶å¾Œæ¯ç•¶æˆ‘å€‘è¦å‚³é€ packet åˆ°å‰ç«¯æ™‚ï¼Œéƒ½æœƒå…ˆä½¿ç”¨socket.io-parser`å°‡ packet çµ¦ encode ï¼Œè€Œè‡´æ–¼ç‚ºä»€éº¼è¦ encode å¾Œåœ¨å‚³å‘¢ ? ä¸»è¦åŸå› ï¼Œå¯èƒ½æ˜¯å¸Œæœ›å„˜å¯èƒ½çš„å°‡è¦å‚³é€å‡ºå»çš„ packet ç¸®å°å·²ç¯€çœå‚³è¼¸æˆæœ¬ã€‚</p>
<p>åƒå®˜æ–¹æ‰€æä¾›çš„<code>socket.io-parser</code>æœƒå°‡ä¸Šé¢çš„ packet åŒ… encode æˆå¦‚ä¸‹æ•¸æ“š :</p>
<pre><code>&quot;2[{&quot;word&quot;:&quot;hello mark&quot;},{&quot;word&quot;:&quot;hello gg&quot;}]&quot;
</code></pre><p>å®ƒçš„ç¢ºæ¯”åŸæœ¬è¦å‚³è¼¸çš„è³‡æ–™é‚„å°‘é»å…’æ±è¥¿ï¼Œç„¶å¾Œå‰ç«¯åœ¨å†ç”¨ç›¸åŒçš„<code>socket.io-parser</code>ä¾†é€²è¡Œ<code>decode</code>ï¼Œè®ŠæˆåŸä¾†çš„ packet åŒ…ã€‚</p>
<p>é€™å°±æ˜¯<code>socket.io-parser</code>æ‰€åšçš„äº‹æƒ…ï¼Œç•¶ç„¶æˆ‘å€‘ä¹Ÿå¯ä»¥è‡ªè¨‚ä¸€å€‹ parser ï¼Œå¦‚æœä½ æœ‰éœ€è¦çš„è©±ï¼Œä¾‹å¦‚ä½ æƒ³ä½¿ç”¨ xml ä¾†ç•¶å‚³è¼¸æ ¼å¼ï¼Œé€™æ™‚ä½ å°±è¦è‡ªè¨‚ä¸€å€‹ parser äº†ï¼Œé›–ç„¶è¦ºå¾—æ‡‰è©²ä¸æœƒæƒ³ç”¨xmlä¾†å‚³ã€‚</p>
<h2 id="socketioadapter">socket.io-adapter</h2>
<p>åœ¨ç†è§£é€™å¥—ä»¶ä¹‹å‰ï¼Œæˆ‘å€‘å…ˆçœ‹çœ‹<code>adapter</code>é€™ä»£è¡¨ä»€éº¼æ„æ€å‘¢ ? æˆ‘å€‘ç›´æ¥ç”¨é€™å€‹å–®å­—å» google åœ–ç‰‡ä¸€ä¸‹ï¼Œç„¶å¾Œå¯ä»¥çœ‹åˆ°ä¸‹åœ–çš„çµæœ :</p>
<p><img src="http://yixiang8780.com/outImg/20171011-2.jpg" alt=""></p>
<p>å—¯å“¼ï¼Œå°±æ˜¯é›»æºè½‰æ¥å™¨ï¼Œåœ¨æ’é ­å’Œæˆ‘å€‘çš„æ©Ÿå™¨ä¹‹é–“æ‰€éœ€è¦çš„æ±è¥¿ï¼Œåœ¨ç¨‹å¼é–‹ç™¼ä¸­ï¼Œä½ æœ‰æ²’æœ‰é‡éä¸‹é¢é€™ç¨®å•é¡Œå‘¢ ?</p>
<blockquote>
<p>æˆ‘å’Œ A è¦ api ä¾†ä½¿ç”¨ï¼Œä½†ç™¼è¦ºå®ƒçš„ api æˆ‘éœ€è¦èª¿æ•´éå¾Œæ‰èƒ½ä½¿ç”¨ã€‚</p>
</blockquote>
<p>æ‰€ä»¥é€šå¸¸ä½ é€™æ™‚ï¼Œæ‡‰è©²ä¸­é–“æœƒæœ‰ä¸€å€‹æ±è¥¿ï¼Œä¾†å‘¼å«é€™éš» api ï¼Œç„¶å¾Œå†è£¡é¢å…ˆæ•´ç†ä¸€ä¸‹ï¼Œç„¶å¾Œæ‰å‚³å‡ºå»çµ¦ä¸»è¦çš„æ–¹æ³•ä¾†ä½¿ç”¨ï¼Œå°å§ ? é€™æ™‚é‚£ä¸­é–“çš„æ±æ±å°±æ˜¯æ‰€è¬‚çš„<code>adapter</code>å®ƒæœ¬èº«å°±æ˜¯ä¸€ç¨®è¨­è¨ˆæ¨¡å¼ã€‚</p>
<p>å¥½å›ä¾†åˆ°<code>socket.io-adapter</code>ï¼Œé‚£æˆ‘å€‘çš„æ’é ­å’Œæ©Ÿå™¨å„ä»£è¡¨ä»€éº¼å‘¢ ? å…ˆä¾†èªªèªªæ©Ÿå™¨ï¼Œæ©Ÿå™¨å°±æ˜¯æˆ‘å€‘çš„ socket.io é‚£æ’é ­å‘¢ ? åš´æ ¼ä¾†èªªæ˜¯<code>å„²å­˜ç©ºé–“</code>ï¼Œå„²å•¥å‘¢ ? å°±æ˜¯<code>namespaceã€roomsã€sids</code>é€™äº›æ±æ±ã€‚</p>
<p><code>socket.io-adapter</code>é è¨­æ˜¯å­˜æ”¾åœ¨è¨˜æ†¶é«”ä¹‹å…§ï¼Œæ‰€ä»¥å¦‚æœä½ è¦ç”¨ redis æˆ– mq ä¹‹é¡çš„ä¾†åšå„²æ”¾ï¼Œä½ å°±åªè¦èª¿æ•´ä½ çš„ adapter å°±å¥½ï¼Œç›®å‰å®˜æ–¹æœ‰æä¾›<code>socket.io-redis</code>å¯ä½¿ç”¨ï¼Œå®ƒä¹Ÿæ˜¯ä¸€å€‹ adapterã€‚</p>
<p>åŸºæœ¬ä¸Šä½ è¦é€²è¡Œä»»ä½• socket.io æä¾›çš„ emitã€broadcastã€join room é€™äº›åŠŸèƒ½ï¼Œéƒ½ä¸€å®šæœƒåˆ°é€™ä¸€å±¤ä¾†åšè™•ç†ã€‚</p>
<h2 id="socketioclient">socket.io-client</h2>
<p>é€™å€‹æ±æ±å°±æ˜¯è®“æˆ‘å€‘åœ¨å‰ç«¯ä½¿ç”¨çš„æ±è¥¿ï¼Œå‡è¨­æˆ‘å€‘åœ¨å¾Œç«¯ server å»ºç«‹å¥½å–”ï¼Œæˆ‘å€‘å°±å¯ä»¥å¦‚ä¸‹é¢é€™æ¨£ï¼Œé€£å»ºç«‹é€£ç·š :</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;/socket.io/socket.io.js&#34;</span><span class="p"></span><span class="p">&gt;</span><span class="p">&lt;</span><span class="p">/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p"></span><span class="p">&gt;</span>
  <span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">(</span><span class="s1">&#39;http://localhost&#39;</span><span class="p">)</span><span class="p">;</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span><span class="p">{</span><span class="p">}</span><span class="p">)</span><span class="p">;</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="p">{</span><span class="p">}</span><span class="p">)</span><span class="p">;</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span><span class="p">{</span><span class="p">}</span><span class="p">)</span><span class="p">;</span>
<span class="p">&lt;</span><span class="p">/</span><span class="nt">script</span><span class="p">&gt;</span>

</code></pre></div><p>ç„¶å¾Œå¦‚æœä½ åœ¨å¾Œç«¯è¦å¯«æ•´åˆæ¸¬è©¦æ™‚ï¼Œæƒ³è¦æ¨¡æ“¬å‰ç«¯ï¼Œä¹Ÿå¯ä»¥å¦‚ä¸‹ä½¿ç”¨ :</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io-client&#39;</span><span class="p">)</span><span class="p">(</span><span class="s1">&#39;http://localhost&#39;</span><span class="p">)</span><span class="p">;</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span><span class="p">{</span><span class="p">}</span><span class="p">)</span><span class="p">;</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="p">{</span><span class="p">}</span><span class="p">)</span><span class="p">;</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span><span class="p">{</span><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</code></pre></div><p>é€™é‚Šé‚„æœ‰ä¸€å€‹é‡é»ï¼Œå®ƒèˆ‡ socket.io ä¸€æ¨£æ ¸å¿ƒéƒ½æ˜¯<code>engine.io-client</code>ä¸¦ä¸”ä¹Ÿæ˜¯ç”±å®ƒä¾†æ±ºå®šæˆ‘å€‘è¦ç”¨ä»€éº¼å‚³è¼¸æ–¹å¼(pollingã€websocket)ã€‚</p>
<h2 id="socketioprotocol">socket.io-protocol</h2>
<p>æœ€å¾Œæ˜¯<code>socket.io-protocol</code>ï¼Œé€™å€‹äº‹å¯¦ä¸Šä¸Šé¢æœ‰èªªæ˜éäº†ï¼Œæˆ‘å€‘åœ¨ä¾†è¤‡ç¿’ä¸€æ¬¡ã€‚</p>
<p>å®ƒæ˜¯å€‹å”å®šï¼Œå®ƒä¸æ˜¯ç¨‹å¼ç¢¼ã€å¥—ä»¶æˆ–å…¶å®ƒå¯ä»¥åŸ·è¡Œçš„æ±è¥¿ï¼Œ<code>å®ƒæ˜¯ä¸€å€‹è¦å®š</code>ï¼Œå®ƒå®šè­°å¥½socket.io è¦å¦‚ä½•çš„å‚³è¼¸è³‡æ–™ï¼Œå®ƒä¸»è¦å®šç¾©äº†ä»¥ä¸‹äºŒå€‹ä¸»é¡Œ :</p>
<h3 id="parser-api">Parser API</h3>
<p><code>Parser API</code>ä¸Šé¢æœ‰æåˆ°ï¼Œå®ƒæ˜¯ç”¨ä¾†å°‡ packet åŒ…é€²è¡Œ encode èˆ‡ decode çš„æ±æ±ï¼Œåœ¨ protocol ä¸­ï¼Œå®ƒå¯¦éš›å®šç¾©ä¸€å€‹ parser api éœ€è¦æœ‰é‚£äº›æ±è¥¿ã€‚</p>
<p>ä¸‹é¢ç‚ºå®ƒçš„ä¸»è¦å®šç¾©</p>
<ul>
<li>Encoder.encode(Object: packet, Function: callback)</li>
<li>Decoder.add(Object:encoding)</li>
</ul>
<p><code>Encoder</code>å°±æ˜¯ç”¨ä¾†é€²è¡Œ encode çš„é¡åˆ¥ï¼Œç„¶å¾Œå®ƒéœ€è¦æä¾›<code>encode</code>æ–¹æ³•ï¼Œä¸¦ä¸”æœ‰å…©å€‹åƒæ•¸åˆ†åˆ¥ç‚º<code>packet å’Œ callback</code>ã€‚</p>
<p>è€Œ<code>Decoder</code>å°±æ˜¯è¦å°‡ packet é€²è¡Œ decod æœƒé¡åˆ¥ï¼Œä¸¦ä¸”éœ€è¦æœ‰å€‹<code>add</code>æ–¹æ³•ï¼Œä¾†é€²è¡Œè™•ç†ã€‚</p>
<p>åƒæˆ‘å€‘ä¸Šé¢æåˆ°çš„<code>socket.io-parser</code>å°±æ˜¯æ ¹æ“š<code>socket.io-protocol</code>æ‰€å®šç¾©çš„<code>parser api</code>å¯¦ä½œå‡ºçš„ç¨‹å¼ç¢¼ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">parser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io-parser&#39;</span><span class="p">)</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">encoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">Encoder</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">packet</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">type</span><span class="o">:</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">EVENT</span><span class="p">,</span>
  <span class="nx">data</span><span class="o">:</span> <span class="s1">&#39;test-packet&#39;</span><span class="p">,</span>
  <span class="nx">id</span><span class="o">:</span> <span class="mi">13</span>
<span class="p">}</span><span class="p">;</span>
<span class="nx">encoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">encodedPackets</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">decoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">Decoder</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="nx">decoder</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;decoded&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">decodedPacket</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// decodedPacket.type == parser.EVENT
</span><span class="c1"></span>    <span class="c1">// decodedPacket.data == &#39;test-packet&#39;
</span><span class="c1"></span>    <span class="c1">// decodedPacket.id == 13
</span><span class="c1"></span>  <span class="p">}</span><span class="p">)</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">encodedPackets</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">decoder</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">encodedPackets</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span><span class="p">)</span><span class="p">;</span>
</code></pre></div><h3 id="packet">Packet</h3>
<p><code>Packet</code>æ˜¯<code>socket.io</code>ä¸–ç•Œè£¡çš„æºé€šåŒ…åŒ…ï¼Œåƒä½ å¦‚æœè¦æ”¾é€è¨Šæ¯æˆ–æ˜¯é€²è¡Œ connect æ™‚ï¼Œå®ƒå€‘éƒ½æ˜¯å‚³é€çš„éƒ½æ˜¯<code>packet</code>ã€‚</p>
<p>åœ¨ protocol ä¸­ï¼Œå®ƒå®šç¾©å¥½äº†ï¼Œä¸€å€‹ packet è¦é•·ä»€éº¼æ¨£å­ :</p>
<pre><code>{
    type: Number,
    data: [],
    id: Number,
}
</code></pre><h4 id="type">type</h4>
<p>å°±æ˜¯ç”¨ä¾†æ±ºå®šï¼Œé€™å€‹åŒ…æ˜¯è¦åšä»€éº¼äº‹æƒ…ï¼Œprotocol å®ƒå®šç¾©äº†ä»¥ä¸‹å¹¾ç¨®é¡å‹ :</p>
<ul>
<li>CONNECT(0)</li>
<li>DISCONNECT(1)</li>
<li>EVENT(2)</li>
<li>ACK(3)</li>
<li>ERROR(4)</li>
<li>BINARY_EVENT(5)</li>
<li>INARRY_ACK(6)</li>
</ul>
<h4 id="data">data</h4>
<p>å°±æ˜¯ä½ é€™å€‹åŒ…å‚³é€çš„è³‡è¨Šï¼Œå®ƒå¸¸éƒ½æ˜¯æˆ‘å€‘è‡ªå·²çš„ï¼Œä¸éè¨˜å¥½ï¼Œå®ƒæ˜¯è¦æ”¾æˆä¸€å€‹é™£åˆ—ã€‚</p>
<h4 id="id">id</h4>
<p>ç”¨ä¾†è­˜åˆ¥é€™å€‹åŒ…æ˜¯èª°çš„ï¼Œéœ€è¦æ™‚åœ¨è¨­å®šã€‚</p>
<h2 id="heading">ç¸½çµ</h2>
<p>æœ€å¾Œæˆ‘å€‘ä¾†ä½¿ç”¨ä¸‹é¢é€™å¼µåœ–ï¼Œä¾†ç¸½çµä¸€ä¸‹ socket.io é€™å€‹ framework çš„æ¶æ§‹ :</p>
<p><img src="http://yixiang8780.com/outImg/20171011-1.png" alt=""></p>
<p>ä¸Šåœ–ç‚º socket.io çš„æ•´é«”æ¶æ§‹ï¼Œæˆ‘å€‘æœ€å¾Œä¾†è¤‡ç¿’ä¸€æ¬¡ã€‚</p>
<p>é¦–å…ˆæœ€ä¸»è¦çš„ä¸»é«”ç‚º<code>engino.io</code>ï¼Œæ‰€æœ‰çš„é€£ç·šã€å‚³è¼¸æ–¹å¼çš„æ ¸å¿ƒéƒ½æ˜¯ä»–ï¼Œç„¶å¾Œç•¶ä½ æƒ³è¦èˆ‡å…¶å®ƒæ±è¥¿é€²è¡Œæºé€šæ™‚ï¼Œå®ƒå€‘çµ±ä¸€çš„æºé€šå…ƒä»¶<code>packet</code>éƒ½éœ€è¦ä½¿ç”¨<code>socket.io-parser</code>ä¾†é€²è¡Œ encode èˆ‡ decode ï¼Œå› ç‚ºæŸäº›å‚³è¼¸æ–¹å¼ websocket åªèƒ½ç”¨æ–‡å­—èˆ‡äºŒé€²ä½æ•¸æ“šï¼Œé‚„æœ‰é€™äº›å®šç¾©éƒ½æœƒå¯«åœ¨ <code>socket.io-protocol</code>è£¡é¢ï¼Œæœ€å¾Œå¦‚æœæƒ³ä½ è¦èˆ‡å„²å­˜å…ƒä»¶æºé€šï¼Œè«‹å»ºç«‹ä¸€å€‹ <code>adapter</code> ä¾†è™•ç†ã€‚</p>
<h2 id="heading1">åƒè€ƒè³‡æ–™</h2>
<ul>
<li><a href="https://github.com/socketio">Socket.io Github</a></li>
</ul>

  </section>

  <section>
    
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "mark-lin" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
  </section>

</article>
<div class="disqus markdown">
    <div id="disqus_thread"></div>
<script>





(function() { 
var d = document, s = d.createElement('script');
s.src = 'https://mark-lin.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
  </div>

      </div>

      <div id="side" class="pr-1">
        <aside class="pr-3">
          
  
    <div id="toc" class="Box Box--blue mb-3">
      <b>Socket.io çš„æ¶æ§‹</b><nav id="TableOfContents">
  <ul>
    <li><a href="#engineio">engine.io</a></li>
    <li><a href="#enginoioclient">engino.io-client</a></li>
    <li><a href="#socketioparser">socket.io-parser</a></li>
    <li><a href="#socketioadapter">socket.io-adapter</a></li>
    <li><a href="#socketioclient">socket.io-client</a></li>
    <li><a href="#socketioprotocol">socket.io-protocol</a>
      <ul>
        <li><a href="#parser-api">Parser API</a></li>
        <li><a href="#packet">Packet</a></li>
      </ul>
    </li>
    <li><a href="#heading">ç¸½çµ</a></li>
    <li><a href="#heading1">åƒè€ƒè³‡æ–™</a></li>
  </ul>
</nav></div>
  

  
    <div>
      
    </div>
  

        </aside>
      </div>

      <div id="footer" class="pt-2 pb-3 text-center">
        




      </div>
    </div>

    
    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>
    
  </body>
</html>
